{% extends 'base.html' %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<style>
    /* Hilangkan instruksi teks default leaflet routing agar rapi di mobile */
    .leaflet-routing-container { display: none !important; }
</style>

<div class="h-screen flex flex-col relative bg-gray-100">
    <div id="map" class="absolute inset-0 z-0"></div>

    <div class="absolute top-0 left-0 right-0 p-4 z-10">
        <div class="bg-white/90 backdrop-blur-md shadow-lg rounded-2xl p-4 flex items-center gap-3">
            <a href="{{ url_for('courier_dashboard') }}" class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-dark hover:bg-gray-200">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="flex-1">
                <h2 class="font-bold text-sm text-dark">Mengantar ke:</h2>
                <p class="text-xs text-gray-600 truncate">{{ order.buyer_name }}</p>
            </div>
            <div class="bg-primary text-white text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm">
                {{ order.status }}
            </div>
        </div>
    </div>

    <div class="absolute bottom-0 left-0 right-0 p-6 z-10">
        <div class="bg-white rounded-2xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] p-5">
            <div class="flex items-center gap-4 mb-4">
                <div class="bg-green-100 p-3 rounded-full text-green-600">
                    <i class="fas fa-map-marker-alt text-xl"></i>
                </div>
                <div>
                    <p class="text-[10px] text-gray-400">Estimasi Tiba</p>
                    <h3 class="font-bold text-lg text-dark">15 Menit <span class="text-xs font-normal text-gray-500">(3.2 km)</span></h3>
                </div>
            </div>
            
            {% if order.status == 'Sedang Diantar' %}
                <a href="{{ url_for('courier_finish_order', oid=order.id) }}" class="block w-full bg-primary hover:bg-lime-500 text-dark font-bold py-4 rounded-xl text-center shadow-lg shadow-lime-500/30 transition">
                    Selesaikan Pesanan
                </a>
            {% else %}
                <button disabled class="block w-full bg-gray-200 text-gray-400 font-bold py-4 rounded-xl text-center cursor-not-allowed">
                    Pesanan Selesai
                </button>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Koordinat Hardcode untuk Demo (Denpasar, Bali area)
    // Dalam aplikasi real, koordinat ini diambil dari database user
    const startLat = -8.670458; 
    const startLng = 115.212629; // Posisi Awal (Misal: Pasar Badung)
    
    // Kita buat koordinat tujuan sedikit random agar terlihat beda tiap order (Simulasi)
    const endLat = {{ -8.68 + (order.id * 0.002) }}; 
    const endLng = {{ 115.22 + (order.id * 0.003) }}; // Posisi Tujuan (Rumah Pembeli)

    // Inisialisasi Map
    var map = L.map('map', { zoomControl: false }).setView([startLat, startLng], 13);

    // Tambahkan Tile Layer (Peta Jalan) - OpenStreetMap (Gratis)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Custom Icon untuk Kurir (Motor)
    var courierIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/3063/3063823.png', // Ikon motor
        iconSize: [40, 40],
        iconAnchor: [20, 20],
        popupAnchor: [0, -20]
    });

    // Custom Icon untuk Pembeli (Rumah)
    var homeIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/25/25694.png', // Ikon rumah
        iconSize: [35, 35],
        iconAnchor: [17, 35],
        popupAnchor: [0, -35]
    });

    // Fitur Routing Machine (Membuat Garis Jalan Otomatis)
    L.Routing.control({
        waypoints: [
            L.latLng(startLat, startLng), // Titik Awal
            L.latLng(endLat, endLng)      // Titik Tujuan
        ],
        routeWhileDragging: false,
        lineOptions: {
            styles: [{color: '#84cc16', opacity: 0.8, weight: 6}] // Warna Hijau (Primary)
        },
        createMarker: function(i, waypoint, n) {
            // Marker Awal (Kurir)
            if (i === 0) {
                return L.marker(waypoint.latLng, {icon: courierIcon})
                    .bindPopup("Posisi Anda");
            }
            // Marker Akhir (Pembeli)
            return L.marker(waypoint.latLng, {icon: homeIcon})
                .bindPopup("Rumah Pembeli: <b>{{ order.buyer_name }}</b>");
        },
        show: false // Sembunyikan panel instruksi teks
    }).addTo(map);
</script>
{% endblock %}